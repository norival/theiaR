---
title: "Quick start guide to TheiaR package"
author: "Xavier Laviron"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    highlight: github
  
vignette: >
  %\VignetteIndexEntry{"Quick start guide to TheiaR package"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## TheiaR package

The TheiaR package intends to provide a clean interface to download and manage
data issued by [Theia](https://theia.cnes.fr/atdistrib/rocket/#/home) through
their API. Basic functionnalities are (for now):

- Search available tiles through Theia API
- Download tiles resulting from a search
- Download tiles contained in a cart (`.meta4` file) obtained from Theia
  website.


## Step-by-step guide

First, load the the package.

```{r}
library(theiaR)
```

To search and download data from Theia, you will need to [register to their
website](https://sso.theia-land.fr/theia/register/register.xhtml).

__NOTE:__ In order to use _Landsat_ or _SpotWorldHeritage_ products, you'll need
to make a first manual download to agree to the license and validate your
account.


### Create a collection of tiles

The first step is to create a collection of tiles. It is achieved by the
`TheiaCollection` class. Its creation can be done from a query or from a cart
file.


#### Create a collection from a query

A query is simply a named `list` of search terms. For example:

```{r , eval=T}
myquery <- list(collection  = "SENTINEL2",
                town        = "Grenoble",
                start.date  = "2018-07-01",
                end.date    = "2018-07-06")
```

will create a query to Theia database, looking for tiles from Sentinel2
satellite around Grenoble, between 2018-07-01 and 2018-07-31.
It accepts the following terms:

* __collection__: The collection to look for. Accepted values are: `SENTINEL2`,
  `Landsat`, `SpotWorldHeritage`, `Snow`, `VENUS`.

* __platform__: The platform to look for. Accepted values are: `LANDSAT5`,
  `LANDSAT7`, `LANDSAT8`, `SPOT1`, `SPOT2`, `SPOT3`, `SPOT4`, `SPOT5`,
  `SENTINEL2A`, `SENTINEL2B`, `VENUS`.

* __town__: The location to look for. Give not too frequent town name.

* __tile__: The tile identifier to retrieve (_eg_ T31TGK)

* __start.date__: The first date to look for (format: `YYYY-MM-DD`).

* __end.date__: The last date to look for (format: `YYYY-MM-DD`).

* __latitude__: The x coordinate of a point.

* __longitude__: The y coordinate of a point.

* __latmin__: The minimum latitude to search.

* __latmax__: The maximum latitude to search.

* __lonmin__: The minimum longitude to search.

* __lonmax__: The maximum longitude to search.

* __max.clouds__: The maximum of cloud cover wanted (0-100).


You can then create your collection with:

```{r}
dir.path <- tempdir()

mycollection <- TheiaCollection$new(query = myquery, dir.path = dir.path)
```

where `dir.path` is the path you want your tiles to be downloaded. If tiles are
already downloaded, it will automatically check the files.

```{r}
print(mycollection)
```


#### From a cart file

Alternatively, you can download a cart from Theia. To create a cart, login to
Theia website, make a [search](https://theia.cnes.fr/atdistrib/rocket/#/home)
for tiles, and add wanted tiles to your cart. Then, download your cart and save
the resulting `.meta4` file to your disk.

You can then create your collection using this file:

```{r , eval=F}
dir.path <- tempdir()

mycollection <- TheiaCollection$new(cart.path = "path/to/cart/file.meta4",
                                    dir.path  = dir.path)
```

As above, it will check files if they are already present on disk.


### Download your tiles

The next step is to download your collection. You can get the status of your
collection by running:

```{r , eval=TRUE}
mycollection$status
```

To download all tiles in a collection, simply run:

```{r , eval=FALSE}
mycollection$download(auth = myauth)
```

where myauth is the path to file storing your Theia credentials. If it does not
exist yet, you will be securely prompted for your login and password, and the
file will be created.

This will check if files are present, check their hashes, and download them if
needed (if files do not exist or checksums are wrong). To overwrite existing
files, run:

```{r , eval=FALSE}
mycollection$download(auth = myauth, overwrite = TRUE)
```


## Acknowledgement

Thanks to Olivier Hagolle for his work on `theia_download.py`
([github](https://theia.cnes.fr/atdistrib/rocket/#/home)), which has inspired
this package.
